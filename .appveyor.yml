version: 0.1.3-{branch}-{build}

environment:
    global:
        RUST_BACKTRACE: full
        RUST_TEST_THREADS: 1
    matrix:
        - channel: stable
          target: x86_64-pc-windows-msvc
          filename: dowser-x64.exe
        - channel: stable
          target: i686-pc-windows-msvc
          filename: dowser-x86.exe

install:
    - curl -sSf -o rustup-init.exe https://win.rustup.rs/
    - rustup-init.exe -y --default-host %target% --default-toolchain %channel%
    - set PATH=%PATH%;C:\Users\appveyor\.cargo\bin
    - rustc -vV
    - cargo -vV
    - rustup install nightly
    - rustup update
    - rustup run nightly cargo install rustfmt-nightly --force

cache:
    - '%USERPROFILE%\.cargo'

build: off

build_script: cargo build

test_script:
    - rustup run nightly cargo fmt --all
    - cargo test --verbose --all -- --nocapture

after_test:
    - cargo build --release --verbose
    - ren target\release\dowser.exe %filename%
    - mkdir dowser-redist-{version}
    - move target\release\%filename% dowser-redist-{version}\%filename
    - curl -vLsSf -o ike-scan.zip https://github.com/royhills/ike-scan/releases/download/1.9/ike-scan-win32-1.9.zip
    - unzip ike-scan.zip
    - move ike-scan-1.9\ike-scan.exe dowser-redist-{version}\ike-scan.exe

artifacts:
    - path: 'dowser-redist-{version}'

deploy:
    description: ''
    auth_token:
        secure: VeDpNYDNNJvMfdBEgizkRlB/Goejuq3IVt5ltSJ48ZVGJpvxBNEApjHAvTuCsNAk
    provider: GitHub
    draft: false
    prerelease: false
    force_update: true
    on:
        appveyor_repo_tag: true
